<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Парсер рейтинга ИТМО</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <meta name="turbo-visit-control" content="reload">
    <style>
        #abitTbody tr.my-row {
            background-color: rgba(32, 201, 151, 0.15) !important;
            position: relative !important;
        }

        @keyframes pulse-highlight {
            0%, 100% { background-color: rgba(32, 201, 151, 0.15) !important; }
            50% { background-color: rgba(32, 201, 151, 0.25) !important; }
        }

        #abitTbody tr.my-row {
            animation: pulse-highlight 2s infinite !important;
        }

        @keyframes pulse-highlight-dark {
            0%, 100% { background-color: rgba(32, 227, 178, 0.18) !important; }
            50% { background-color: rgba(32, 227, 178, 0.28) !important; }
        }

        body.dark-mode #abitTbody tr.my-row {
            animation: pulse-highlight-dark 2s infinite !important;
            background-color: rgba(32, 227, 178, 0.18) !important;
        }
    </style>
</head>
<body>
    <button class="theme-toggle btn btn-light border position-fixed top-0 end-0 m-3" id="themeToggle" type="button"
        title="Переключить тему">
        <i class="bi bi-moon-stars-fill" id="themeToggleIcon"></i>
    </button>
    <div class="container-fluid mt-3 mb-4">
        <h1 class="text-center mb-4">Рейтинг абитуриентов ИТМО</h1>
        <div class="row g-3 equal-height">
            <!-- Левая колонка -->
            <div class="col-lg-3">
                <div class="card h-100">
                    <div class="card-header bg-teal text-white">
                        <h5 class="mb-0">Фильтры и поиск</h5>
                    </div>
                    <div class="card-body d-flex flex-column">
                        <form method="POST" class="flex-grow-1 d-flex flex-column">
                            <div class="mb-3">
                                <label for="url" class="form-label">URL страницы</label>
                                <input type="text" class="form-control" id="url" name="url"
                                       value="{{ filters.url }}" required>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Основной высший приоритет (ОВП)</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="ovp" id="ovp-any"
                                           value="any" {{ 'checked' if filters.ovp is none }}>
                                    <label class="btn btn-outline-teal" for="ovp-any">Неважно</label>

                                    <input type="radio" class="btn-check" name="ovp" id="ovp-yes"
                                           value="yes" {{ 'checked' if filters.ovp == true }}>
                                    <label class="btn btn-outline-teal" for="ovp-yes">Да</label>

                                    <input type="radio" class="btn-check" name="ovp" id="ovp-no"
                                           value="no" {{ 'checked' if filters.ovp == false }}>
                                    <label class="btn btn-outline-teal" for="ovp-no">Нет</label>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Высший проходной приоритет (ВПП)</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="vpp" id="vpp-any"
                                           value="any" {{ 'checked' if filters.vpp is none }}>
                                    <label class="btn btn-outline-teal" for="vpp-any">Неважно</label>

                                    <input type="radio" class="btn-check" name="vpp" id="vpp-yes"
                                           value="yes" {{ 'checked' if filters.vpp == true }}>
                                    <label class="btn btn-outline-teal" for="vpp-yes">Да</label>

                                    <input type="radio" class="btn-check" name="vpp" id="vpp-no"
                                           value="no" {{ 'checked' if filters.vpp == false }}>
                                    <label class="btn btn-outline-teal" for="vpp-no">Нет</label>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Согласие на зачисление</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="consent" id="consent-any"
                                           value="any" {{ 'checked' if filters.consent is none }}>
                                    <label class="btn btn-outline-teal" for="consent-any">Неважно</label>

                                    <input type="radio" class="btn-check" name="consent" id="consent-yes"
                                           value="yes" {{ 'checked' if filters.consent == true }}>
                                    <label class="btn btn-outline-teal" for="consent-yes">Да</label>

                                    <input type="radio" class="btn-check" name="consent" id="consent-no"
                                           value="no" {{ 'checked' if filters.consent == false }}>
                                    <label class="btn btn-outline-teal" for="consent-no">Нет</label>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="exam_type" class="form-label">Вид испытания</label>
                                <select class="form-select" id="exam_type" name="exam_type">
                                    <option value="Все">Все виды испытаний</option>
                                    {% for exam_type in exam_types %}
                                    <option value="{{ exam_type }}" {{ 'selected' if filters.exam_type == exam_type }}>
                                        {{ exam_type }}
                                    </option>
                                    {% endfor %}
                                    <option value="БВИ" {{ 'selected' if filters.exam_type == "БВИ" }}>БВИ</option>
                                </select>
                            </div>

                            <div class="d-flex align-items-center mb-3">
                                <div class="form-check form-switch m-0 me-2"> <!-- Добавил me-2 для отступа справа -->
                                    <input class="form-check-input" type="checkbox" id="showAdvancedFilters">
                                </div>
                                <label class="form-label mb-0" for="showAdvancedFilters">Фильтр по баллам</label> <!-- Вынес label наружу и добавил mb-0 -->
                            </div>

                            <div id="advancedFilters" style="display: none;">
                                <div class="mb-3">
                                    <div class="row g-1 align-items-end">
                                        <!-- Средний балл -->
                                        <div class="col">
                                            <select class="form-select" name="average_score_op">
                                                <option value="">—</option>
                                                <option value="ge" {% if filters.average_score_op == "ge" %}selected{% endif %}>&ge;</option>
                                                <option value="g"  {% if filters.average_score_op == "g"  %}selected{% endif %}>&gt;</option>
                                                <option value="le" {% if filters.average_score_op == "le" %}selected{% endif %}>&le;</option>
                                                <option value="l"  {% if filters.average_score_op == "l"  %}selected{% endif %}>&lt;</option>
                                                <option value="eq" {% if filters.average_score_op == "eq" %}selected{% endif %}>=</option>
                                            </select>
                                            <input type="number" step="0.0001" class="form-control mt-1" name="average_score_val"
                                                value="{{ filters.average_score_val or '' }}" placeholder="Средний">
                                        </div>
                                        <!-- Балл ВИ -->
                                        <div class="col">
                                            <select class="form-select" name="exam_score_op">
                                                <option value="">—</option>
                                                <option value="ge" {% if filters.exam_score_op == "ge" %}selected{% endif %}>&ge;</option>
                                                <option value="g"  {% if filters.exam_score_op == "g"  %}selected{% endif %}>&gt;</option>
                                                <option value="le" {% if filters.exam_score_op == "le" %}selected{% endif %}>&le;</option>
                                                <option value="l"  {% if filters.exam_score_op == "l"  %}selected{% endif %}>&lt;</option>
                                                <option value="eq" {% if filters.exam_score_op == "eq" %}selected{% endif %}>=</option>
                                            </select>
                                            <input type="number" step="0.01" class="form-control mt-1" name="exam_score_val"
                                                value="{{ filters.exam_score_val or '' }}" placeholder="ВИ">
                                        </div>
                                        <!-- Балл ВИ+ИД -->
                                        <div class="col">
                                            <select class="form-select" name="total_score_op">
                                                <option value="">—</option>
                                                <option value="ge" {% if filters.total_score_op == "ge" %}selected{% endif %}>&ge;</option>
                                                <option value="g"  {% if filters.total_score_op == "g"  %}selected{% endif %}>&gt;</option>
                                                <option value="le" {% if filters.total_score_op == "le" %}selected{% endif %}>&le;</option>
                                                <option value="l"  {% if filters.total_score_op == "l"  %}selected{% endif %}>&lt;</option>
                                                <option value="eq" {% if filters.total_score_op == "eq" %}selected{% endif %}>=</option>
                                            </select>
                                            <input type="number" step="0.01" class="form-control mt-1" name="total_score_val"
                                                value="{{ filters.total_score_val or '' }}" placeholder="ВИ+ИД">
                                        </div>
                                    </div>
                                </div>
                            </div>


                            <div class="mb-3">
                                <label for="stats_id" class="form-label">Ваш номер заявления (для анализа места)</label>
                                <input type="text" class="form-control" id="stats_id" name="stats_id"
                                       value="{{ filters.stats_id or '' }}" placeholder="Например, 4302097">
                            </div>


                            <button type="submit" class="btn btn-teal mt-auto">
                                <i class="bi bi-funnel-fill"></i> Применить фильтры
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Правая колонка -->
            <div class="col-lg-9">
                {% if error %}
                <div class="alert alert-danger" role="alert">
                    {{ error }}
                </div>
                {% endif %}

                <div class="card h-100">
                    <div class="card-header bg-teal text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Результаты : {{ filtered_count }} записей</h5>
                    </div>
                    <div class="card-body p-0">
                        {% if stats and 'my_row' in stats %}
                        <script>
                            window.myApplicationId = "{{ stats.my_row.application_id }}";
                        </script>
                        <div class="d-flex flex-wrap align-items-center gap-3">
                            <strong class="fs-5 me-2">Перед вами ({{ stats.my_row.filtered_position }} место):</strong>

                            <div class="stat-pill" data-bs-toggle="tooltip" title="Всего абитуриентов">
                                <span class="stat-label">Всего</span>
                                <span class="stat-value">{{ stats.total_before_me }}</span>
                            </div>

                            <div class="stat-pill" data-bs-toggle="tooltip" title="С льготами БВИ">
                                <span class="stat-label">БВИ</span>
                                <span class="stat-value text-primary">{{ stats.bvi_before }}</span>
                            </div>

                            <div class="stat-pill" data-bs-toggle="tooltip" title="С особым правом">
                                <span class="stat-label">ОВП</span>
                                <span class="stat-value text-info">{{ stats.ovp_before }}</span>
                            </div>

                            <div class="stat-pill" data-bs-toggle="tooltip" title="Подали согласие">
                                <span class="stat-label">Согласия</span>
                                <span class="stat-value text-success">{{ stats.consent_before }}</span>
                            </div>
                        </div>
                        {% endif %}

                        {% if applicants %}
                        <script>
                            window.abitData = {{ applicants | tojson }};
                        </script>
                        <div class="table-container">
                            <table class="table table-striped table-hover mb-0" id="abitTable">
                                <thead class="table-teal sticky-top">
                                    <tr>
                                        <th class="sortable" data-field="filtered_position">№ <span class="sort-arrow"></span></th>
                                        <th class="sortable" data-field="position">Поз. (рейтинг) <span class="sort-arrow"></span></th>
                                        <th class="sortable" data-field="application_id">№ заявления <span class="sort-arrow"></span></th>
                                        <th class="sortable" data-field="exam_type">Вид испытания <span class="sort-arrow"></span></th>
                                        <th class="sortable" data-field="exam_score">Балл ВИ <span class="sort-arrow"></span></th>
                                        <th class="sortable" data-field="total_score">Балл ВИ+ИД <span class="sort-arrow"></span></th>
                                        <th class="sortable" data-field="average_score">Средний балл <span class="sort-arrow"></span></th>
                                        <th class="sortable" data-field="priority">Приоритет <span class="sort-arrow"></span></th>
                                        <th class="sortable" data-field="ovp">ОВП <span class="sort-arrow"></span></th>
                                        <th class="sortable" data-field="vpp">ВПП <span class="sort-arrow"></span></th>
                                        <th class="sortable" data-field="consent">Согласие <span class="sort-arrow"></span></th>
                                    </tr>
                                </thead>
                                <tbody id="abitTbody">
                                    <!-- Таблица будет отрисовываться через JS -->
                                </tbody>
                                <!--
                                <tbody>

                                    {% for app in applicants %}
                                    <tr {% if stats.my_row and app.application_id == stats.my_row.application_id %}class="table-success fw-bold"{% endif %}>
                                        <td>{{ app.filtered_position }}</td>
                                        <td>{{ app.position }}</td>
                                        <td>{{ app.application_id }}</td>
                                        <td>{{ app.exam_type }}</td>
                                        <td>{{ app.exam_score }}</td>
                                        <td>{{ app.total_score }}</td>
                                        <td>{{ "%.4f"|format(app.average_score) }}</td>
                                        <td>{{ app.priority }}</td>
                                        <td>
                                            <span class="badge bg-{{ 'teal' if app.ovp else 'secondary' }}">
                                                {{ 'Да' if app.ovp else 'Нет' }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'teal' if app.vpp else 'secondary' }}">
                                                {{ 'Да' if app.vpp else 'Нет' }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'teal' if app.consent else 'gray' }}">
                                                {{ 'Да' if app.consent else 'Нет' }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>-->
                            </table>
                        </div>
                        {% else %}
                        <div class="d-flex align-items-center justify-content-center h-100">
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-info-circle-fill" style="font-size: 3rem;"></i>
                                <p class="mt-3">Используйте фильтры для отображения данных</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Простое переключение темы
      // Переключение темы с сохранением в localStorage
        const body = document.body;
        const toggleBtn = document.getElementById('themeToggle');
        const toggleIcon = document.getElementById('themeToggleIcon');

        // Инициализация темы
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            setDarkMode(savedTheme === 'dark');
        }

        function setDarkMode(on) {
            if (on) {
                body.classList.add('dark-mode');
                toggleIcon.classList.replace('bi-moon-stars-fill', 'bi-sun-fill');
                localStorage.setItem('theme', 'dark');
            } else {
                body.classList.remove('dark-mode');
                toggleIcon.classList.replace('bi-sun-fill', 'bi-moon-stars-fill');
                localStorage.setItem('theme', 'light');
            }
        }

        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', initTheme);

        // Обработчик клика
        toggleBtn.addEventListener('click', () => {
            setDarkMode(!body.classList.contains('dark-mode'));
        });
    </script>
    <script>
        // ... существующие скрипты ...
        // Advanced filters toggle
        document.addEventListener('DOMContentLoaded', function () {
            const advToggle = document.getElementById('showAdvancedFilters');
            const advBlock = document.getElementById('advancedFilters');

            // Восстановление при возврате на страницу (если хоть 1 поле заполнено — оставить раскрытым)
            let anyAdvanced = false;
            [
                '{{ filters.average_score_op }}',
                '{{ filters.average_score_val }}',
                '{{ filters.exam_score_op }}',
                '{{ filters.exam_score_val }}',
                '{{ filters.total_score_op }}',
                '{{ filters.total_score_val }}'
            ].forEach(function(val){
                if(val && val.trim && val.trim().length > 0) anyAdvanced = true;
            });

            if(anyAdvanced) {
                advBlock.style.display = '';
                advToggle.checked = true;
            }

            advToggle.addEventListener('change', function () {
                if (this.checked) {
                    advBlock.style.display = '';
                } else {
                    advBlock.style.display = 'none';
                    // Можно добавить очистку advanced-полей если хочешь
                }
            });
        });
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        let allData = window.abitData || [];
        let data = [...allData]; // изначальный порядок

        // Сортировка: массив [{field, direction}] — первое поле главное, вторые и далее — по важности
        let sortState = []; // [{field, dir}] dir=1(asc), -1(desc)

        // Все sortable th
        const headers = Array.from(document.querySelectorAll('#abitTable th.sortable'));
        // Мапа: field -> th
        const headersMap = {};
        headers.forEach(th => headersMap[th.dataset.field] = th);

        function renderTable(dataArr) {
            const tbody = document.getElementById('abitTbody');
            tbody.innerHTML = '';
            const myApplicationId = window.myApplicationId || null;
            dataArr.forEach(app => {
                const tr = document.createElement('tr');
                if (myApplicationId && app.application_id === myApplicationId) {
                    tr.classList.add('my-row');
                }
                tr.innerHTML = `
                    <td>${app.filtered_position}</td>
                    <td>${app.position}</td>
                    <td><span class="number-highlight" onclick="copyToClipboard(this.textContent)">${app.application_id}</span></td>
                    <td>${app.exam_type}</td>
                    <td>${app.exam_score}</td>
                    <td>${app.total_score}</td>
                    <td>${Number(app.average_score).toFixed(4)}</td>
                    <td>${app.priority}</td>
                    <td><span class="badge bg-${app.ovp ? 'teal' : 'secondary'}">${app.ovp ? 'Да' : 'Нет'}</span></td>
                    <td><span class="badge bg-${app.vpp ? 'teal' : 'secondary'}">${app.vpp ? 'Да' : 'Нет'}</span></td>
                    <td><span class="badge bg-${app.consent ? 'teal' : 'soft-red'}">${app.consent ? 'Да' : 'Нет'}</span></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                console.log('Скопировано: ' + text); // Для отладки
                // Опционально: Показать toast или алерт
                alert('Номер ' + text + ' скопирован в буфер обмена!');
            }).catch(function(err) {
                console.error('Ошибка копирования: ', err);
                alert('Ошибка копирования. Попробуйте выделить и скопировать вручную.');
            });
        }

        // Рисуем стрелки и выделение в th (отмечаем только первое поле из sortState)
        function updateHeaderSortVisual() {
            headers.forEach(th => {
                th.classList.remove('active-sort');
                th.querySelector('.sort-arrow').textContent = '';
            });
            if(sortState.length === 0) return;
            let first = sortState[0];
            let th = headersMap[first.field];
            th.classList.add('active-sort');
            const arrow = th.querySelector('.sort-arrow');
            if (first.dir === 1) arrow.textContent = '▲';
            else if (first.dir === -1) arrow.textContent = '▼';
            else arrow.textContent = '';
        }

        // Функция для сравнения по массиву полей
        function multiCompare(a, b) {
            for (let s of sortState) {
                let field = s.field, dir = s.dir;
                let va = a[field], vb = b[field];

                // Для boolean-полей
                if (typeof va === "boolean") {
                    va = va ? 1 : 0;
                    vb = vb ? 1 : 0;
                }
                // Для числовых
                if (!isNaN(parseFloat(va)) && !isNaN(parseFloat(vb)) && (typeof va !== "string" || va.trim() !== "")) {
                    va = parseFloat(va);
                    vb = parseFloat(vb);
                }
                // Сравнение
                if (va < vb) return -1 * dir;
                if (va > vb) return 1 * dir;
            }
            return 0;
        }

        // Клик по заголовку — циклическая сортировка: asc ➔ desc ➔ off
        headers.forEach(th => {
            th.addEventListener('click', function(e) {
                const field = th.getAttribute('data-field');
                // ищем поле в sortState
                let idx = sortState.findIndex(f => f.field === field);
                if (idx === -1) {
                    // новое поле — делаем первым, asc
                    sortState.unshift({field: field, dir: 1});
                } else {
                    // поле уже в sortState — меняем режим
                    if (sortState[idx].dir === 1) {
                        sortState[idx].dir = -1;
                    } else if (sortState[idx].dir === -1) {
                        sortState.splice(idx, 1);
                    }
                }
                // После клика — всегда делаем кликнутый столбец на первое место
                sortState = [
                    ...sortState.filter(f => f.field === field),
                    ...sortState.filter(f => f.field !== field)
                ];
                // Если ничего не осталось — показываем в исходном порядке
                let sorted = sortState.length === 0 ? [...allData] : [...data].sort(multiCompare);
                renderTable(sorted);
                updateHeaderSortVisual();
                data = [...sorted];
            });
        });

        // Первичный рендер
        renderTable(data);
        updateHeaderSortVisual();
    });
    </script>
    {% if stats and 'my_row' in stats %}
    <script>
        // Добавляем эту функцию после загрузки страницы и всех скриптов
        window.addEventListener('load', function() {
            // Находим нужное ID
            const myId = "{{ stats.my_row.application_id }}";
            console.log("Ищем ID:", myId);
            // Находим все строки таблицы
            const rows = document.querySelectorAll('#abitTbody tr');
            // Проверяем каждую строку
            rows.forEach(row => {
                // Ищем ячейку с ID заявления (3-я колонка, индекс 2)
                const idCell = row.querySelector('td:nth-child(3)');
                if (idCell && idCell.textContent === myId) {
                    console.log("Найдена строка для ID:", myId);
                    // Напрямую устанавливаем стиль без класса
                    row.style.backgroundColor = 'rgba(32, 201, 151, 0.2)';
                    // Прокручиваем к этой строке
                    row.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }
            });
        });
    </script>
    {% endif %}
    <script>
    // Этот скрипт выполняется после загрузки страницы
    document.addEventListener('DOMContentLoaded', function() {
        // Для отладки - выводим в консоль ID
        console.log("Ищем строку для ID:", window.myApplicationId);

        // Функция, которая будет пытаться найти и выделить строку
        function highlightMyRow() {
            if (!window.myApplicationId) return;

            const rows = document.querySelectorAll('#abitTbody tr');
            let found = false;

            rows.forEach(function(row) {
                const cells = row.querySelectorAll('td');
                if (cells.length > 2 && cells[2].textContent.trim() === window.myApplicationId) {
                    console.log("Нашли строку для ID:", window.myApplicationId);
                    row.classList.add('my-row');
                    found = true;
                }
            });

            return found;
        }

        // Пытаемся найти сразу
        if (!highlightMyRow()) {
            // Если не удалось найти сразу, пробуем еще раз через секунду
            setTimeout(highlightMyRow, 1000);
        }
    });
    </script>

</body>
</html>
